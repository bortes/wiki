# Instalar Bitcoin Core (full node)

Instalação do Bitcoin Core versão v0.16.0.

## Requisitos

+ 4 GB de RAM e 200 GB de espaço em disco - [sugerido aqui](https://bitcoin.org/en/full-node#minimum-requirements)
+ Ubuntu 16.04 LTS ou superiorgb

## TL;DR

Para facilitar, execute [este shell script](./FULL_NODE_FILES/run.sh) que contém deste manual:

```bash
$ curl https://github.com/bortes/wiki/blob/master/BITCOIN/FULL_NODE_FILES/run.sh | sudo bash
```

## Por que

Porque para comprendermos sobre blockchain e criptmoedas precisamos conhecer o Bitcoin.

## Repositório

> &nbsp;
> [Criaremos um usuário](../LINUX/USER.md) chamdo **bitcoin**, grupo **bitcoin**, para executar o Bitcoin Core.
> &nbsp;

As configurações deverão ser salvas em **/etc/opt/bitcoin**.

```bash
$ sudo mkdir -p /etc/opt/bitcoin
```

Os arquivos irão ser salvos em **/var/opt/bitcoin**.

```bash
$ sudo mkdir -p /var/opt/bitcoin
```

Uma vez que o Bitcoin Core não será executado com o usuário **root** devemos modificar o proprietário dos diretórios acima.

```bash
$ sudo chown bitcoin:bitcoin /etc/opt/bitcoin /var/opt/bitcoin
```

## Instalação

Primeiro repositório para o Bitcoin Core.

```bash
$ sudo mkdir -p /opt/bitcoin/bitcoin-core
```

Depois efetuar o download dos binários.

```bash
$ sudo wget https://bitcoin.org/bin/bitcoin-core-0.16.0/bitcoin-0.16.0-x86_64-linux-gnu.tar.gz -P /opt/bitcoin/bitcoin-core
```

Após o termino do download, descompactaremos o arquivo obtido.

```bash
$ sudo tar xzf /opt/bitcoin/bitcoin-core/bitcoin-0.16.0-x86_64-linux-gnu.tar.gz -C /opt/bitcoin/bitcoin-core/
```

Em seguida, criaremos uma referência para a versão atual instalada no servidor.

```bash
$ sudo ln -s /opt/bitcoin/bitcoin-core/bitcoin-0.16.0 /opt/bitcoin/bitcoin-core/current
```

Então, criamos os links para os executáveis.

```bash
$ sudo find /opt/bitcoin/bitcoin-core/current/ -type f -executable -exec sudo ln -s -f  {} /usr/local/bin/ \;
```

_Fonte: [Running A Full Node](https://bitcoin.org/en/full-node#other-linux-distributions)_

## Otimização

Abaixo regra para otimizar o desempenho do Bitcoin Core.

### número de arquivos abertos

O blockchain do Bitcoin utiliza o [LevelDB](https://github.com/google/leveldb), o qual organiza suas informações em vários arquivos dentro de algumas pastas.

Então, vamos modificar o [número de arquivos abertos](../LINUX/FD.md) como sendo **1024**.

_**ATENÇÃO**: este ajuste somente faz sentido em máquinas 32 bits, pois para as de 64 bits o LevelDB foi [alterado para não consumir a tabelas de arquivos abertos](https://github.com/bitcoin/bitcoin/blob/master/doc/developer-notes.md#file-descriptor-counts)._

## Configuração

Para nossa configuração, é preciso determinar em qual rede o nosso nó estará conectado:

+ Mainnet, [Bitcoin Main Network](https://bitcoin.org/en/glossary/mainnet)
+ Testnet, [Testing Network](https://bitcoin.org/en/glossary/testnet)
+ Regtest, [Regression Test Mode](https://bitcoin.org/en/glossary/regression-test-mode)

Vamos conectar o nosso nó com a **testnet**.

Também habilitamos a conexão com outros nós na porta **8333** e o acesso via RPC na porta **8332** para a credêncial do usuário **meu\_usuario** com a senha **minha\_senha**.

_**ATENÇÃO**: por segurança, ALTERE AS PORTAS E AS CREDÊNCIAIS de acesso via RPC!_

_**IMPORTANTE**: é preciso habilitar o acesso externo as portas 8333 e 8332!_

Vamos criar o arquivo de configuração _/etc/opt/bitcoin/bitcoin.conf_ com o seguinte conteúdo:

```ini
# Generated by https://jlopp.github.io/bitcoin-core-config-generator/

# [debug]
# Run this node on the Bitcoin Test Network.
testnet=1

# [network]
# Maintain at most N connections to peers.
maxconnections=4
# Listen for incoming connections on non-default port.
port=18333

# [rpc]
# Accept command line and JSON-RPC commands.
server=1
# Allow JSON-RPC connections from specified source. Valid for <ip> are a single IP (e.g. 1.2.3.4), a network/netmask (e.g. 1.2.3.4/255.255.255.0) or a network/CIDR (e.g. 1.2.3.4/24). This option can be specified multiple times.
rpcallowip=0.0.0.0/0
# Listen for JSON-RPC connections on this port
rpcport=18332
# Username for JSON-RPC connections
rpcuser=meu_usuario
# Password for JSON-RPC connections
rpcpassword=minha_senha
```

## Execução

Por fim, o arquivo para execução do Bitcoin Core com _serviço_ em _/etc/systemd/system/bitcoind.service_ com o seguinte conteúdo:

```ini
[Unit]
# sobre
Description=Bitcoin node
# executar apos
After=network.target

[Service]
# comando que sera executado
ExecStart=/usr/local/bin/bitcoind -daemon -conf=/etc/opt/bitcoin/bitcoin.conf -pid=/var/opt/bitcoin/bitcoind.pid -datadir=/var/opt/bitcoin/
# usuario e grupo para execucao
User=bitcoin
Group=bitcoin
# espera ate a execucao do comando para identificar se o servico foi iniciado com sucesso
Type=forking
# define o caminho absolute para o identificador do processo
PIDFile=/var/opt/bitcoin/bitcoind.pid
# regra para reiniciar o servico sempre que ele nao for terminado com sucesso - exit code 0
Restart=on-failure
# define um /tmp e /var/tmp especifico para o servico
PrivateTmp=true
# monta o /usr, o /boot e o /etc como somente leitura
ProtectSystem=full
# define que o servico e seus filhos nao pode ganhar novas permissoes
NoNewPrivileges=true
# define um /dev especifico para o servico
PrivateDevices=true

[Install]
# aguardar
WantedBy=multi-user.target
```

> &nbsp;
> Configuração baseada no [modelo da Bitcoin.org](https://github.com/bitcoin/bitcoin/blob/master/contrib/init/bitcoind.service).
> &nbsp;

Abriremos as seguintes portas:

+ 18332, acesso via RPC
+ 18333, acesso para conexão com outros nós 

Continuando, concedemos permissão para execução do nosso _serviço_.

```bash
$ sudo chmod +751 /etc/systemd/system/bitcoind.service
```

Ainda, devemos atualizar a lista de _serviços_ disponíveis no sistema operacional.

```bash
$ sudo systemctl daemon-reload
```

Logo após, ativamos o _serviço_.

```bash
$ sudo systemctl enable bitcoind
```

Resultado:

```
Created symlink from /etc/systemd/system/multi-user.target.wants/bitcoind.service to /etc/systemd/system/bitcoind.service.
```

Finalmente, inicializamos ele.

```bash
$ sudo systemctl start bitcoind
```

Podemos consultamos o estado do _serviço_:

```bash
$ systemctl status bitcoind
```

Caso o _serviço_ esteja funcionando corretamente, o resultado será:

```text
● bitcoind.service - Bitcoin node
   Loaded: loaded (/etc/systemd/system/bitcoind.service; disabled; vendor preset: enabled)
   Active: active (running) since Thu 2018-05-10 21:21:49 UTC; 2min 19s ago
  Process: 3370 ExecStart=/usr/bin/bitcoind -daemon -pid=/home/bitcoin/.bitcoin/bitcoind.pid -conf=/home/bitcoin/.bitcoin/bitcoin.conf (code=exited, status=0/SUCCESS)
 Main PID: 3384 (bitcoind)
    Tasks: 12
   Memory: 1.0G
      CPU: 1min 40.041s
   CGroup: /system.slice/bitcoind.service
           └─3384 /usr/bin/bitcoind -daemon -pid=/home/bitcoin/.bitcoin/bitcoind.pid -conf=/home/bitcoin/.bitcoin/bitcoin.conf

May 10 21:21:49 btc-ext systemd[1]: Starting Bitcoin node...
May 10 21:21:49 btc-ext systemd[1]: bitcoind.service: PID file /home/bitcoin/.bitcoin/bitcoind.pid not readable (yet?) after start: No such file or directory
```

**PRONTO!** NOSSO BITCOIN CORE ESTÁ EM EXECUÇÃO E PRONTO PARA UTILIZAR.

Podemos também confirmar o sucesso utilizando o comando **netstat** para verificar se as portas utilizadas estão abertas:

```bash
$ netstat -tnlp | grep LIST
```

Resultado:

```
(Not all processes could be identified, non-owned process info
 will not be shown, you would have to be root to see it all.)
tcp        0      0 0.0.0.0:8333            0.0.0.0:*               LISTEN      -
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -
tcp6       0      0 :::18333                :::*                    LISTEN      -
tcp6       0      0 :::18332                :::*                    LISTEN      -
tcp6       0      0 :::22                   :::*                    LISTEN      -
```

Ou podemos confirmar utilizando o comando **bitcoin-cli** com a opção _getblockchaininfo_.

```bash
$ bitcoin-cli getblockchaininfo
```

Resultado:

```javascript
{
  "chain": "test",
  "blocks": 485735,
  "headers": 1297193,
  "bestblockhash": "0000000002ad0b3e6f031c121f7f98e67d278ecce52b1b21843fcbc8ab8a4dcb",
  "difficulty": 1,
  "mediantime": 1435373308,
  "verificationprogress": 0.256426321786972,
  "initialblockdownload": true,
  "chainwork": "00000000000000000000000000000000000000000000000455542eabb3664b8e",
  "size_on_disk": 2271479629,
  "pruned": false,
  "softforks": [
    {
      "id": "bip34",
      "version": 2,
      "reject": {
        "status": true
      }
    },
    {
      "id": "bip66",
      "version": 3,
      "reject": {
        "status": true
      }
    },
    {
      "id": "bip65",
      "version": 4,
      "reject": {
        "status": false
      }
    }
  ],
  "bip9_softforks": {
    "csv": {
      "status": "defined",
      "startTime": 1456790400,
      "timeout": 1493596800,
      "since": 0
    },
    "segwit": {
      "status": "defined",
      "startTime": 1462060800,
      "timeout": 1493596800,
      "since": 0
    }
  },
  "warnings": ""
}
```

_Fonte: [Remote Procedure Calls (RPCs)](https://bitcoin.org/en/developer-reference#remote-procedure-calls-rpcs)_
